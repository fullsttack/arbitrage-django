<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{{ page_title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Toast Animations */
        .toast-enter {
            transform: translateX(100%);
            opacity: 0;
        }
        .toast-enter-active {
            transform: translateX(0);
            opacity: 1;
            transition: all 0.3s ease-out;
        }
        .toast-exit {
            transform: translateX(0);
            opacity: 1;
        }
        .toast-exit-active {
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease-in;
        }

        /* Update Flash Effects */
        .flash-update {
            animation: flash-update 1s ease-out;
            background-color: rgba(34, 197, 94, 0.2) !important;
        }
        @keyframes flash-update {
            0% { background-color: rgba(34, 197, 94, 0.4); }
            50% { background-color: rgba(34, 197, 94, 0.6); }
            100% { background-color: rgba(34, 197, 94, 0.1); }
        }

        .flash-new {
            animation: flash-new 1.5s ease-out;
        }
        @keyframes flash-new {
            0% { background-color: rgba(59, 130, 246, 0.4); transform: scale(1.02); }
            50% { background-color: rgba(59, 130, 246, 0.7); transform: scale(1.01); }
            100% { background-color: transparent; transform: scale(1); }
        }

        .flash-profit {
            animation: flash-profit 2s ease-out;
        }
        @keyframes flash-profit {
            0% { background-color: rgba(245, 158, 11, 0.3); border-left: 3px solid rgb(245, 158, 11); }
            50% { background-color: rgba(245, 158, 11, 0.6); border-left: 3px solid rgb(245, 158, 11); }
            100% { background-color: transparent; border-left: 3px solid transparent; }
        }

        /* Pulse for high profit */
        .pulse-profit {
            animation: pulse-profit 2s infinite;
        }
        @keyframes pulse-profit {
            0%, 100% { background-color: rgba(34, 197, 94, 0.2); }
            50% { background-color: rgba(34, 197, 94, 0.4); }
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen font-sans">
    <!-- Header -->
    <header class="bg-gray-900 border-b border-gray-800">
        <div class="w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-primary-500 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold">Crypto Arbitrage Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connection-status" class="flex items-center">
                        <div id="status-indicator" class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                        <span id="status-text" class="text-sm">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <!-- Stats Overview -->
    <section class="container mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <!-- Best Opportunity -->
            <div class="bg-gradient-to-r from-yellow-900 to-orange-900 rounded-xl p-6 border border-yellow-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-yellow-200 text-sm">Best Opportunity</p>
                        <p id="stat-best-profit" class="text-2xl font-bold text-yellow-400">-</p>
                        <p id="stat-best-pair" class="text-xs text-yellow-300 mt-1">-</p>
                    </div>
                    <div class="bg-yellow-500 bg-opacity-30 p-3 rounded-lg">
                        <i class="fas fa-trophy text-yellow-400 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Opportunities -->
            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Opportunities</p>
                        <p id="stat-opportunities" class="text-2xl font-bold text-green-500">-</p>
                    </div>
                    <div class="bg-green-500 bg-opacity-20 p-3 rounded-lg">
                        <i class="fas fa-coins text-green-500 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Active Prices -->
            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Active Prices</p>
                        <p id="stat-prices" class="text-2xl font-bold text-blue-500">-</p>
                    </div>
                    <div class="bg-blue-500 bg-opacity-20 p-3 rounded-lg">
                        <i class="fas fa-chart-bar text-blue-500 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Redis Memory -->
            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Redis Memory</p>
                        <p id="stat-memory" class="text-2xl font-bold text-yellow-500">-</p>
                    </div>
                    <div class="bg-yellow-500 bg-opacity-20 p-3 rounded-lg">
                        <i class="fas fa-memory text-yellow-500 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- System Health -->
            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">System Health</p>
                        <p id="stat-health" class="text-2xl font-bold text-purple-500">-</p>
                    </div>
                    <div class="bg-purple-500 bg-opacity-20 p-3 rounded-lg">
                        <i class="fas fa-heartbeat text-purple-500 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-gray-900 rounded-xl border border-gray-800">
            <div class="border-b border-gray-800">
                <nav class="flex space-x-8 px-6" role="tablist">
                    <button id="tab-prices" class="tab-button active py-4 px-2 border-b-2 border-primary-500 text-primary-500 font-medium" role="tab">
                        <i class="fas fa-dollar-sign mr-2"></i>Live Prices
                    </button>
                    <button id="tab-opportunities" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-white font-medium" role="tab">
                        <i class="fas fa-bullseye mr-2"></i>Opportunities
                    </button>
                    <button id="tab-monitoring" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-white font-medium" role="tab">
                        <i class="fas fa-monitor-waveform mr-2"></i>Monitoring
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Prices Tab -->
                <div id="content-prices" class="tab-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Live Price Feed</h2>
                        <div class="flex items-center space-x-4">
                            <span id="prices-count" class="text-sm text-gray-400">0 active prices</span>
                            <span id="prices-last-update" class="text-sm text-gray-400">Last update: -</span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-800">
                                    <th class="text-left py-3 px-4 text-gray-400">Exchange</th>
                                    <th class="text-left py-3 px-4 text-gray-400">Symbol</th>
                                    <th class="text-left py-3 px-4 text-gray-400">Currency</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Bid Price</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Ask Price</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Spread</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Bid Volume</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Ask Volume</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Last Update</th>
                                </tr>
                            </thead>
                            <tbody id="prices-table-body" class="divide-y divide-gray-800">
                                <tr>
                                    <td colspan="9" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <div>Loading price data...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Opportunities Tab -->
                <div id="content-opportunities" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Arbitrage Opportunities</h2>
                        <div class="flex items-center space-x-4">
                            <span id="opportunities-count" class="text-sm text-gray-400">0 opportunities</span>
                            <span id="opportunities-last-update" class="text-sm text-gray-400">Last update: -</span>
                        </div>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="opportunities-pagination" class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-2">
                            <button id="prev-page" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                Previous
                            </button>
                            <span id="page-info" class="text-sm text-gray-400">Page 1 of 1</span>
                            <button id="next-page" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-400">Show:</span>
                            <select id="items-per-page" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="text-sm text-gray-400">per page</span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-800">
                                    <th class="text-left py-3 px-4 text-gray-400">Symbol</th>
                                    <th class="text-left py-3 px-4 text-gray-400">Buy Exchange</th>
                                    <th class="text-left py-3 px-4 text-gray-400">Sell Exchange</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Buy Price</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Buy Volume</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Sell Price</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Sell Volume</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Profit %</th>
                                    <th class="text-right py-3 px-4 text-gray-400">Last Seen</th>
                                </tr>
                            </thead>
                            <tbody id="opportunities-table-body" class="divide-y divide-gray-800">
                                <tr>
                                    <td colspan="9" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-search text-2xl mb-2"></i>
                                        <div>Scanning for opportunities...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Monitoring Tab -->
                <div id="content-monitoring" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">System Monitoring</h2>
                        <div class="flex items-center space-x-4">
                            <span id="monitoring-last-update" class="text-sm text-gray-400">Last update: -</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Exchange Status -->
                        <div class="bg-gray-800 rounded-lg p-6">
                            <h3 class="text-lg font-semibold mb-4">Exchange Connections</h3>
                            <div id="exchange-status" class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
                                        <span>Wallex</span>
                                    </div>
                                    <span class="text-sm text-gray-400">Connecting...</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
                                        <span>LBank</span>
                                    </div>
                                    <span class="text-sm text-gray-400">Connecting...</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
                                        <span>Ramzinex</span>
                                    </div>
                                    <span class="text-sm text-gray-400">Connecting...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Redis Statistics -->
                        <div class="bg-gray-800 rounded-lg p-6">
                            <h3 class="text-lg font-semibold mb-4">Redis Statistics</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Memory Used:</span>
                                    <span id="redis-memory">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Connected Clients:</span>
                                    <span id="redis-clients">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Operations/sec:</span>
                                    <span id="redis-ops">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Hit Rate:</span>
                                    <span id="redis-hit-rate">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Uptime:</span>
                                    <span id="redis-uptime">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // CSRF Token Helper
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        class ArbitrageDashboard {
            constructor() {
                this.websocket = null;
                this.reconnectInterval = 5000;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 10;
                this.pricesData = new Map();
                this.opportunitiesData = [];
                this.opportunitiesMap = new Map(); // For duplicate detection
                this.currencyNames = {};
                this.bestOpportunity = null;
                this.lastUpdateTimes = new Map();
                this.totalOpportunitiesCount = 0; // ÿ™ÿπÿØÿßÿØ ⁄©ŸÑ ÿßÿ≤ Redis
                this.isInitialDataLoaded = false; // Ÿæÿ±⁄ÜŸÖ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿßŸàŸÑ€åŸá
                
                // Pagination
                this.currentPage = 1;
                this.itemsPerPage = 20;
                
                this.init();
            }

            cleanupOldOpportunities() {
                const currentTime = Date.now() / 1000;
                const maxAge = 300; // 5 minutes
                
                // Remove opportunities older than 5 minutes
                this.opportunitiesData = this.opportunitiesData.filter(opp => {
                    const oppTime = opp.last_seen || opp.timestamp || 0;
                    const isValid = (currentTime - oppTime) <= maxAge;
                    
                    if (!isValid && opp.frontend_key) {
                        this.opportunitiesMap.delete(opp.frontend_key);
                    }
                    
                    return isValid;
                });
            }

            init() {
                this.setupTabs();
                this.setupPagination();
                
                // ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿßŸàŸÑ€åŸá ÿØÿßÿØŸá‚ÄåŸáÿß ÿßÿ≤ API ŸÇÿ®ŸÑ ÿßÿ≤ WebSocket
                this.loadInitialData().then(() => {
                    // Ÿæÿ≥ ÿßÿ≤ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖŸàŸÅŸÇÿå WebSocket ÿ±ÿß ÿ±ÿßŸá‚ÄåÿßŸÜÿØÿßÿ≤€å ⁄©ŸÜ
                    this.setupWebSocket();
                    this.isInitialDataLoaded = true;
                }).catch(error => {
                    console.error('Failed to load initial data:', error);
                    // ÿ≠ÿ™€å ÿØÿ± ÿµŸàÿ±ÿ™ ÿÆÿ∑ÿßÿå WebSocket ÿ±ÿß ÿ±ÿßŸá‚ÄåÿßŸÜÿØÿßÿ≤€å ⁄©ŸÜ
                    this.setupWebSocket();
                });
                
                // Auto-refresh stats every 30 seconds
                setInterval(() => this.loadSystemStats(), 30000);
                
                // Cleanup old opportunities every 60 seconds
                setInterval(() => this.cleanupOldOpportunities(), 60000);
            }

            setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const tabId = button.id.replace('tab-', '');
                        
                        // Update button states
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active', 'border-primary-500', 'text-primary-500');
                            btn.classList.add('border-transparent', 'text-gray-400');
                        });
                        
                        button.classList.add('active', 'border-primary-500', 'text-primary-500');
                        button.classList.remove('border-transparent', 'text-gray-400');
                        
                        // Update content visibility
                        tabContents.forEach(content => {
                            content.classList.add('hidden');
                        });
                        
                        document.getElementById(`content-${tabId}`).classList.remove('hidden');
                    });
                });
            }

            setupWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/arbitrage/`;
                
                try {
                    this.websocket = new WebSocket(wsUrl);
                    
                    this.websocket.onopen = () => {
                        console.log('WebSocket connected');
                        this.updateConnectionStatus(true);
                        this.reconnectAttempts = 0;
                    };
                    
                    this.websocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    };
                    
                    this.websocket.onclose = () => {
                        console.log('WebSocket disconnected');
                        this.updateConnectionStatus(false);
                        this.attemptReconnect();
                    };
                    
                    this.websocket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateConnectionStatus(false);
                    };
                    
                } catch (error) {
                    console.error('Failed to create WebSocket:', error);
                    this.updateConnectionStatus(false);
                }
            }

            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
                    
                    setTimeout(() => {
                        this.setupWebSocket();
                    }, this.reconnectInterval);
                } else {
                    console.error('Max reconnection attempts reached');
                    this.showToast('Connection lost. Please refresh the page.', 'error');
                }
            }

            handleWebSocketMessage(data) {
                console.log('WebSocket message received:', data.type, data.data?.length || 'no data');
                
                switch (data.type) {
                    case 'initial_prices':
                        this.updatePricesTable(data.data);
                        break;
                    case 'price_update':
                        this.updateSinglePrice(data.data);
                        break;
                    case 'initial_opportunities':
                        // ŸÅŸÇÿ∑ ÿß⁄Øÿ± ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿßŸàŸÑ€åŸá ÿßÿ≤ API ŸÑŸàÿØ ŸÜÿ¥ÿØŸá ÿ®ÿßÿ¥ÿØ
                        if (!this.isInitialDataLoaded) {
                            console.log('Loading initial opportunities from WebSocket:', data.data?.length || 0);
                            this.handleInitialOpportunities(data.data);
                        } else {
                            console.log('Skipping WebSocket initial opportunities (API data already loaded)');
                        }
                        break;
                    case 'opportunities_update':
                        console.log('Opportunities update received:', data.data?.length || 0);
                        this.handleNewOpportunities(data.data);
                        break;
                    case 'best_opportunity_update':
                        // ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ®Ÿáÿ™ÿ±€åŸÜ ŸÅÿ±ÿµÿ™ ÿßÿ≤ WebSocket
                        console.log('Best opportunity update from WebSocket');
                        this.updateBestOpportunityDisplay(data.data);
                        break;
                    case 'redis_stats':
                        this.updateSystemStats(data.data);
                        break;
                }
            }

            handleInitialOpportunities(opportunities) {
                // Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ ÿØÿßÿØŸá‚ÄåŸáÿß€å ŸÇÿ®ŸÑ€å
                this.opportunitiesData = [];
                this.opportunitiesMap.clear();
                
                // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ŸÅÿ±ÿµÿ™‚ÄåŸáÿß€å ÿßŸàŸÑ€åŸá
                if (opportunities && Array.isArray(opportunities)) {
                    opportunities.forEach(opp => this.addOrUpdateOpportunity(opp));
                }
                
                this.updateOpportunitiesTable();
            }

            createOpportunityKey(opp) {
                // Create composite key similar to backend
                const keyParts = [
                    opp.buy_exchange || '',
                    opp.sell_exchange || '',
                    opp.symbol || (opp.base_currency + '/' + opp.quote_currency),
                    (opp.buy_price || 0).toFixed(10),
                    (opp.sell_price || 0).toFixed(10),
                    (opp.buy_volume || 0).toFixed(8),
                    (opp.sell_volume || 0).toFixed(8)
                ];
                return keyParts.join('|');
            }

            addOrUpdateOpportunity(opportunity) {
                const key = this.createOpportunityKey(opportunity);
                const existing = this.opportunitiesMap.get(key);
                
                if (existing) {
                    // Update existing opportunity
                    existing.last_seen = opportunity.last_seen || opportunity.timestamp;
                    existing.seen_count = (existing.seen_count || 1) + 1;
                    console.debug(`Updated existing opportunity: ${opportunity.symbol} (${key.substring(0, 20)}...)`);
                    return false; // Not new
                } else {
                    // Add new opportunity
                    opportunity.frontend_key = key;
                    opportunity.seen_count = 1;
                    this.opportunitiesMap.set(key, opportunity);
                    
                    // Add to array (at beginning for newest first)
                    this.opportunitiesData.unshift(opportunity);
                    
                    // ÿ≠ÿ∞ŸÅ ŸÖÿ≠ÿØŸàÿØ€åÿ™ - ÿ®⁄Øÿ∞ÿßÿ± ŸáŸÖŸá ŸÅÿ±ÿµÿ™‚ÄåŸáÿß ŸÜ⁄ØŸáÿØÿßÿ±€å ÿ¥ŸàŸÜÿØ ÿ™ÿß ÿ®ÿß Redis ŸáŸÖÿßŸáŸÜ⁄Ø ÿ®ÿßÿ¥ÿØ
                    // Redis ÿ≠ÿØÿß⁄©ÿ´ÿ± 10000 ŸÅÿ±ÿµÿ™ ŸÜ⁄ØŸáÿØÿßÿ±€å ŸÖ€å⁄©ŸÜÿØ Ÿà ŸÖÿß ÿ™ÿß 1000 ŸÜŸÖÿß€åÿ¥ ŸÖ€åÿØŸá€åŸÖ
                    
                    console.debug(`Added new opportunity: ${opportunity.symbol} - ${opportunity.profit_percentage.toFixed(2)}%`);
                    return true; // Is new
                }
            }

            handleNewOpportunities(newOpportunities) {
                if (!Array.isArray(newOpportunities) || newOpportunities.length === 0) {
                    return;
                }

                console.log(`Processing ${newOpportunities.length} opportunities from WebSocket`);
                
                let hasNewOpportunities = false;
                const trulyNewOpportunities = [];

                // Process each opportunity
                newOpportunities.forEach(opp => {
                    const isNew = this.addOrUpdateOpportunity(opp);
                    if (isNew) {
                        hasNewOpportunities = true;
                        trulyNewOpportunities.push(opp);
                    }
                });
                
                console.log(`Found ${trulyNewOpportunities.length} truly new opportunities`);
                
                // Only update UI if we have truly new opportunities
                if (hasNewOpportunities) {
                    // Update table
                    this.updateOpportunitiesTable();
                    
                    // Show notification for high profit opportunities
                    const highProfitOpps = trulyNewOpportunities.filter(opp => opp.profit_percentage > 1.5);
                    if (highProfitOpps.length > 0) {
                        const bestNew = highProfitOpps.reduce((best, current) => 
                            current.profit_percentage > best.profit_percentage ? current : best
                        );
                        
                        const baseSymbol = bestNew.base_currency || this.extractBaseSymbol(bestNew.symbol);
                        const currencyName = bestNew.currency_name || this.currencyNames[baseSymbol] || baseSymbol;
                        
                        this.showToast(
                            `üöÄ New ${currencyName} opportunity: ${bestNew.profit_percentage.toFixed(2)}% profit (${bestNew.buy_exchange} ‚Üí ${bestNew.sell_exchange})`,
                            'success'
                        );
                    }
                } else {
                    console.log('No new opportunities to display (all were duplicates)');
                }
            }

            updateBestOpportunityDisplay(bestOpp) {
                if (!bestOpp) {
                    document.getElementById('stat-best-profit').textContent = '-';
                    document.getElementById('stat-best-pair').textContent = '-';
                    this.bestOpportunity = null;
                    return;
                }
                
                // Update display
                document.getElementById('stat-best-profit').textContent = `${bestOpp.profit_percentage.toFixed(2)}%`;
                
                const baseSymbol = bestOpp.base_currency || this.extractBaseSymbol(bestOpp.symbol);
                const currencyName = bestOpp.currency_name || this.currencyNames[baseSymbol] || baseSymbol;
                
                document.getElementById('stat-best-pair').textContent = 
                    `${currencyName} (${bestOpp.buy_exchange} ‚Üí ${bestOpp.sell_exchange})`;
                
                // Add animation if it's a new best
                if (!this.bestOpportunity || bestOpp.profit_percentage > this.bestOpportunity.profit_percentage + 0.01) {
                    const profitElement = document.getElementById('stat-best-profit');
                    profitElement.classList.add('flash-profit');
                    setTimeout(() => {
                        profitElement.classList.remove('flash-profit');
                    }, 2000);
                }
                
                this.bestOpportunity = bestOpp;
            }

            updateConnectionStatus(connected) {
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                
                if (connected) {
                    indicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    text.textContent = 'Connected';
                } else {
                    indicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                    text.textContent = 'Disconnected';
                }
            }

            updatePricesTable(prices) {
                const tbody = document.getElementById('prices-table-body');
                
                if (!prices || prices.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-8 text-gray-500">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <div>No price data available</div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Store prices and detect updates
                const currentTime = Date.now();
                prices.forEach(price => {
                    const key = `${price.exchange}_${price.symbol}`;
                    const previousPrice = this.pricesData.get(key);
                    this.pricesData.set(key, price);
                    
                    if (previousPrice && 
                        (previousPrice.bid_price !== price.bid_price || 
                         previousPrice.ask_price !== price.ask_price)) {
                        this.lastUpdateTimes.set(key, currentTime);
                    }
                });

                // Render table
                tbody.innerHTML = prices.map(price => {
                    const spread = ((price.ask_price - price.bid_price) / price.bid_price * 100).toFixed(2);
                    const timeAgo = this.getTimeAgo(price.timestamp);
                    const key = `${price.exchange}_${price.symbol}`;
                    
                    const baseSymbol = this.extractBaseSymbol(price.symbol);
                    const currencyName = price.currency_name || this.currencyNames[baseSymbol] || baseSymbol;
                    
                    const lastUpdate = this.lastUpdateTimes.get(key) || 0;
                    const isRecentlyUpdated = (currentTime - lastUpdate) < 2000;
                    const animationClass = isRecentlyUpdated ? 'flash-update' : '';
                    
                    return `
                        <tr class="hover:bg-gray-800 transition-colors ${animationClass}" data-key="${key}">
                            <td class="py-3 px-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${price.exchange}
                                </span>
                            </td>
                            <td class="py-3 px-4 font-medium">${price.symbol}</td>
                            <td class="py-3 px-4 text-gray-300">${currencyName}</td>
                            <td class="py-3 px-4 text-right text-green-400">${price.bid_price.toFixed(4)}</td>
                            <td class="py-3 px-4 text-right text-red-400">${price.ask_price.toFixed(4)}</td>
                            <td class="py-3 px-4 text-right">${spread}%</td>
                            <td class="py-3 px-4 text-right text-blue-400">${price.bid_volume.toFixed(2)}</td>
                            <td class="py-3 px-4 text-right text-orange-400">${price.ask_volume.toFixed(2)}</td>
                            <td class="py-3 px-4 text-right text-gray-400">${timeAgo}</td>
                        </tr>
                    `;
                }).join('');

                // Remove animation after completion
                setTimeout(() => {
                    const animatedRows = tbody.querySelectorAll('.flash-update');
                    animatedRows.forEach(row => row.classList.remove('flash-update'));
                }, 1000);

                // Update counts
                document.getElementById('prices-count').textContent = `${prices.length} active prices`;
                document.getElementById('prices-last-update').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
            }

            updateSinglePrice(priceData) {
                const key = `${priceData.exchange}_${priceData.symbol}`;
                const previousPrice = this.pricesData.get(key);
                this.pricesData.set(key, priceData);
                
                if (previousPrice && 
                    (previousPrice.bid_price !== priceData.bid_price || 
                     previousPrice.ask_price !== priceData.ask_price)) {
                    this.lastUpdateTimes.set(key, Date.now());
                }
                
                // Auto-update table if on prices tab
                if (!document.getElementById('content-prices').classList.contains('hidden')) {
                    this.updatePricesTable(Array.from(this.pricesData.values()));
                }
            }

            updateOpportunitiesTable() {
                const tbody = document.getElementById('opportunities-table-body');
                
                if (!this.opportunitiesData || this.opportunitiesData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-8 text-gray-500">
                                <i class="fas fa-search text-2xl mb-2"></i>
                                <div>No opportunities found</div>
                            </td>
                        </tr>
                    `;
                    this.updatePaginationControls(0);
                    return;
                }

                // Pagination
                const totalPages = Math.ceil(this.opportunitiesData.length / this.itemsPerPage);
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const paginatedData = this.opportunitiesData.slice(startIndex, endIndex);

                tbody.innerHTML = paginatedData.map(opp => {
                    const profitClass = opp.profit_percentage > 2 ? 'text-green-400 pulse-profit' : 
                                      opp.profit_percentage > 1 ? 'text-green-400' : 'text-yellow-400';
                    const timeAgo = this.getTimeAgo(opp.last_seen || opp.timestamp);
                    
                    return `
                        <tr class="hover:bg-gray-800 transition-colors">
                            <td class="py-3 px-4 font-medium">${opp.symbol || opp.base_currency + '/' + opp.quote_currency}</td>
                            <td class="py-3 px-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    ${opp.buy_exchange}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    ${opp.sell_exchange}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-right text-green-400">${opp.buy_price.toFixed(4)}</td>
                            <td class="py-3 px-4 text-right text-blue-400">${(opp.buy_volume || 0).toFixed(2)}</td>
                            <td class="py-3 px-4 text-right text-red-400">${opp.sell_price.toFixed(4)}</td>
                            <td class="py-3 px-4 text-right text-orange-400">${(opp.sell_volume || 0).toFixed(2)}</td>
                            <td class="py-3 px-4 text-right font-bold ${profitClass}">
                                ${opp.profit_percentage.toFixed(2)}%
                            </td>
                            <td class="py-3 px-4 text-right text-gray-400">${timeAgo}</td>
                        </tr>
                    `;
                }).join('');

                // Update counts and pagination - ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ ÿ™ÿπÿØÿßÿØ ŸÖÿ≠ŸÑ€å ŸÅÿ±ÿµÿ™‚ÄåŸáÿß (ŸÜŸá ⁄©ŸÑ Redis)
                document.getElementById('opportunities-count').textContent = `${this.opportunitiesData.length} opportunities shown`;
                document.getElementById('opportunities-last-update').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
                this.updatePaginationControls(this.opportunitiesData.length);
            }

            updatePaginationControls(totalItems) {
                const validTotalItems = Math.max(0, totalItems || 0);
                const totalPages = Math.max(1, Math.ceil(validTotalItems / this.itemsPerPage));
                
                if (this.currentPage > totalPages) {
                    this.currentPage = totalPages;
                }
                if (this.currentPage < 1) {
                    this.currentPage = 1;
                }
                
                document.getElementById('page-info').textContent = `Page ${this.currentPage} of ${totalPages}`;
                
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                
                if (prevBtn && nextBtn) {
                    prevBtn.disabled = this.currentPage <= 1;
                    nextBtn.disabled = this.currentPage >= totalPages || validTotalItems === 0;
                    
                    prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
                    prevBtn.classList.toggle('cursor-not-allowed', prevBtn.disabled);
                    nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
                    nextBtn.classList.toggle('cursor-not-allowed', nextBtn.disabled);
                }
            }

            updateSystemStats(stats) {
                // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ ÿ™ÿπÿØÿßÿØ ⁄©ŸÑ ÿßÿ≤ Redis ÿ®ÿ±ÿß€å ÿ®ÿß⁄©ÿ≥ ÿ®ÿßŸÑÿß
                document.getElementById('stat-opportunities').textContent = stats.opportunities_count || 0;
                document.getElementById('stat-prices').textContent = stats.prices_count || 0;
                document.getElementById('stat-memory').textContent = stats.redis_memory || 'N/A';
                document.getElementById('stat-health').textContent = `${stats.redis_clients || 0} clients`;
                
                // ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿπÿØÿßÿØ ⁄©ŸÑ
                this.totalOpportunitiesCount = stats.opportunities_count || 0;
                
                // Update monitoring tab
                document.getElementById('redis-memory').textContent = stats.redis_memory || 'N/A';
                document.getElementById('redis-clients').textContent = stats.redis_clients || 0;
                document.getElementById('redis-ops').textContent = stats.redis_ops_per_sec || 0;
                document.getElementById('redis-hit-rate').textContent = stats.redis_hit_rate || 'N/A';
                document.getElementById('redis-uptime').textContent = this.formatUptime(stats.uptime || 0);
                
                document.getElementById('monitoring-last-update').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
            }

            showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                
                const bgColor = type === 'success' ? 'bg-green-600' : 
                               type === 'error' ? 'bg-red-600' : 'bg-blue-600';
                
                const icon = type === 'success' ? 'check-circle' : 
                           type === 'error' ? 'exclamation-circle' : 'info-circle';
                
                toast.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 toast-enter max-w-md`;
                toast.innerHTML = `
                    <i class="fas fa-${icon} flex-shrink-0"></i>
                    <span class="flex-1">${message}</span>
                    <button class="text-white hover:text-gray-200 flex-shrink-0">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(toast);
                
                // Trigger animation
                setTimeout(() => {
                    toast.classList.remove('toast-enter');
                    toast.classList.add('toast-enter-active');
                }, 10);
                
                // Auto remove
                setTimeout(() => {
                    this.removeToast(toast);
                }, 5000);
                
                // Manual remove
                toast.querySelector('button').addEventListener('click', () => {
                    this.removeToast(toast);
                });
            }

            removeToast(toast) {
                toast.classList.remove('toast-enter-active');
                toast.classList.add('toast-exit-active');
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }

            setupPagination() {
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                const itemsSelect = document.getElementById('items-per-page');
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        if (this.currentPage > 1) {
                            this.currentPage--;
                            this.updateOpportunitiesTable();
                        }
                    });
                }
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        const totalPages = Math.ceil(this.opportunitiesData.length / this.itemsPerPage);
                        if (this.currentPage < totalPages) {
                            this.currentPage++;
                            this.updateOpportunitiesTable();
                        }
                    });
                }
                
                if (itemsSelect) {
                    itemsSelect.addEventListener('change', (e) => {
                        this.itemsPerPage = parseInt(e.target.value);
                        this.currentPage = 1;
                        this.updateOpportunitiesTable();
                    });
                }
            }

            async loadInitialData() {
                try {
                    const headers = {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    };
                    
                    console.log('Loading initial data from API...');
                    
                    // Load opportunities first
                    const oppsResponse = await fetch('/api/opportunities/', {
                        method: 'GET',
                        headers: headers,
                        credentials: 'same-origin'
                    });
                    if (oppsResponse.ok) {
                        const oppsData = await oppsResponse.json();
                        if (oppsData.success) {
                            console.log(`Loaded ${oppsData.data?.length || 0} opportunities from API`);
                            
                            if (oppsData.currency_names) {
                                this.currencyNames = { ...this.currencyNames, ...oppsData.currency_names };
                            }
                            
                            // Clear and reload opportunities with duplicate detection
                            this.opportunitiesData = [];
                            this.opportunitiesMap.clear();
                            
                            if (oppsData.data && Array.isArray(oppsData.data)) {
                                oppsData.data.forEach(opp => this.addOrUpdateOpportunity(opp));
                            }
                            
                            this.updateOpportunitiesTable();
                            
                            // Update best opportunity from API
                            if (oppsData.best_opportunity) {
                                this.updateBestOpportunityDisplay(oppsData.best_opportunity);
                            }
                            
                            // ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿπÿØÿßÿØ ⁄©ŸÑ
                            this.totalOpportunitiesCount = oppsData.total_count || 0;
                        }
                    }
                    
                    // Load prices
                    const pricesResponse = await fetch('/api/prices/', {
                        method: 'GET',
                        headers: headers,
                        credentials: 'same-origin'
                    });
                    if (pricesResponse.ok) {
                        const pricesData = await pricesResponse.json();
                        if (pricesData.success) {
                            if (pricesData.currency_names) {
                                this.currencyNames = { ...this.currencyNames, ...pricesData.currency_names };
                            }
                            this.updatePricesTable(pricesData.data);
                        }
                    }
                    
                    // Load system stats
                    await this.loadSystemStats();
                    
                    console.log('Initial data loaded successfully from API');
                    
                } catch (error) {
                    console.error('Failed to load initial data:', error);
                    this.showToast('Failed to load initial data', 'error');
                    throw error; // Re-throw to handle in init()
                }
            }

            async loadSystemStats() {
                try {
                    const headers = {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    };
                    
                    const response = await fetch('/api/stats/', {
                        method: 'GET',
                        headers: headers,
                        credentials: 'same-origin'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.updateSystemStats(data.data);
                            
                            // ÿß⁄Øÿ± ÿ®Ÿáÿ™ÿ±€åŸÜ ŸÅÿ±ÿµÿ™ ÿØÿ± stats Ÿàÿ¨ŸàÿØ ÿØÿßÿ¥ÿ™ÿå ÿ¢ŸÜ ÿ±ÿß ŸÜŸÖÿß€åÿ¥ ÿ®ÿØŸá
                            if (data.data.best_opportunity) {
                                this.updateBestOpportunityDisplay(data.data.best_opportunity);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Failed to load system stats:', error);
                }
            }

            getTimeAgo(timestamp) {
                const now = Date.now() / 1000;
                const diff = now - timestamp;
                
                if (diff < 60) return `${Math.floor(diff)}s ago`;
                if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
                return `${Math.floor(diff / 86400)}d ago`;
            }

            formatUptime(seconds) {
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                
                if (days > 0) return `${days}d ${hours}h`;
                if (hours > 0) return `${hours}h ${mins}m`;
                return `${mins}m`;
            }

            extractBaseSymbol(symbolFormat) {
                try {
                    const symbolUpper = symbolFormat.toUpperCase();
                    
                    if (symbolUpper.includes('/')) {
                        return symbolUpper.split('/')[0];
                    }
                    if (symbolUpper.includes('_')) {
                        return symbolUpper.split('_')[0];
                    }
                    if (symbolUpper.endsWith('USDT')) {
                        return symbolUpper.slice(0, -4);
                    }
                    if (symbolUpper.endsWith('TMN')) {
                        return symbolUpper.slice(0, -3);
                    }
                        
                    return symbolUpper;
                } catch {
                    return symbolFormat;
                }
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new ArbitrageDashboard();
        });
    </script>
</body>
</html>