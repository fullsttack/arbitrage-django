{% extends 'base.html' %}

{% block title %}Admin Panel - Crypto Arbitrage Monitor{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">Admin Panel</h1>
    <p class="text-gray-400">Manage exchanges, currencies, and trading pairs</p>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="stat-card">
        <h3 class="text-lg font-semibold text-white mb-1">Total Exchanges</h3>
        <p class="text-2xl font-bold text-blue-400">{{ exchanges|length }}</p>
        <p class="text-sm text-gray-400">{{ exchanges|length }} configured</p>
    </div>

    <div class="stat-card">
        <h3 class="text-lg font-semibold text-white mb-1">Trading Pairs</h3>
        <p class="text-2xl font-bold text-green-400">{{ pairs|length }}</p>
        <p class="text-sm text-gray-400">{{ currencies|length }} currencies</p>
    </div>

    <div class="stat-card">
        <h3 class="text-lg font-semibold text-white mb-1">System Status</h3>
        <p class="text-2xl font-bold text-purple-400">Active</p>
        <p class="text-sm text-gray-400">All systems operational</p>
    </div>
</div>

<!-- Tab Navigation -->
<div class="flex space-x-2 mb-6">
    <button id="tab-exchanges" class="tab-button active">Exchanges</button>
    <button id="tab-pairs" class="tab-button">Trading Pairs</button>
    <button id="tab-currencies" class="tab-button">Currencies</button>
    <button id="tab-settings" class="tab-button">Settings</button>
</div>

<!-- Tab Content -->
<div class="space-y-6">
    <!-- Exchanges Tab -->
    <div id="content-exchanges" class="tab-content">
        <div class="table-container">
            <div class="p-6 border-b border-gray-700/50 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-semibold text-white">Exchanges Management</h2>
                    <p class="text-gray-400 text-sm mt-1">Configure and monitor exchange connections</p>
                </div>
                <a href="/admin/core/exchange/add/" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Add Exchange
                </a>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-800/50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Display Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">WebSocket</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700/50">
                        {% for exchange in exchanges %}
                        <tr class="hover:bg-gray-700/50 transition-colors">
                            <td class="px-4 py-3 text-sm font-medium text-white">{{ exchange.name }}</td>
                            <td class="px-4 py-3 text-sm text-gray-300">{{ exchange.display_name }}</td>
                            <td class="px-4 py-3 text-sm">
                                {% if exchange.websocket_url %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        ✓ Available
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        ✗ None
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <button class="toggle-btn exchange-toggle {{ exchange.is_active|yesno:'active,inactive' }}" 
                                        data-id="{{ exchange.id }}"
                                        data-type="exchange">
                                    {% if exchange.is_active %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            ✓ Active
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            ✗ Inactive
                                        </span>
                                    {% endif %}
                                </button>
                            </td>
                            <td class="px-4 py-3 text-sm font-medium">
                                <div class="flex space-x-2">
                                    <a href="/admin/core/exchange/{{ exchange.id }}/change/" 
                                       class="text-blue-400 hover:text-blue-300 transition-colors">Edit</a>
                                    <button class="test-connection text-green-400 hover:text-green-300 transition-colors" 
                                            data-exchange="{{ exchange.name }}">Test</button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                No exchanges configured
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Trading Pairs Tab -->
    <div id="content-pairs" class="tab-content hidden">
        <div class="table-container">
            <div class="p-6 border-b border-gray-700/50 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-semibold text-white">Trading Pairs Management</h2>
                    <p class="text-gray-400 text-sm mt-1">Configure trading pairs and arbitrage settings</p>
                </div>
                <a href="/admin/core/tradingpair/add/" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    Add Trading Pair
                </a>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-800/50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Exchange</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pair</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Symbol</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Threshold %</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Volume Range</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700/50">
                        {% for pair in pairs %}
                        <tr class="hover:bg-gray-700/50 transition-colors">
                            <td class="px-4 py-3 text-sm font-medium text-blue-400">{{ pair.exchange.display_name }}</td>
                            <td class="px-4 py-3 text-sm text-white">{{ pair.base_currency.symbol }}/{{ pair.quote_currency.symbol }}</td>
                            <td class="px-4 py-3 text-sm text-gray-300 font-mono">{{ pair.symbol_format }}</td>
                            <td class="px-4 py-3 text-sm text-yellow-400">{{ pair.arbitrage_threshold }}%</td>
                            <td class="px-4 py-3 text-sm text-gray-400">{{ pair.min_volume }} - {{ pair.max_volume }}</td>
                            <td class="px-4 py-3 text-sm">
                                <button class="toggle-btn pair-toggle {{ pair.is_active|yesno:'active,inactive' }}" 
                                        data-id="{{ pair.id }}"
                                        data-type="pair">
                                    {% if pair.is_active %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            ✓ Active
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            ✗ Inactive
                                        </span>
                                    {% endif %}
                                </button>
                            </td>
                            <td class="px-4 py-3 text-sm font-medium">
                                <div class="flex space-x-2">
                                    <a href="/admin/core/tradingpair/{{ pair.id }}/change/" 
                                       class="text-blue-400 hover:text-blue-300 transition-colors">Edit</a>
                                    <button class="test-pair text-green-400 hover:text-green-300 transition-colors" 
                                            data-exchange="{{ pair.exchange.name }}" 
                                            data-symbol="{{ pair.api_symbol }}">Test</button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                No trading pairs configured
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Currencies Tab -->
    <div id="content-currencies" class="tab-content hidden">
        <div class="table-container">
            <div class="p-6 border-b border-gray-700/50 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-semibold text-white">Currencies Management</h2>
                    <p class="text-gray-400 text-sm mt-1">Manage supported cryptocurrencies</p>
                </div>
                <a href="/admin/core/currency/add/" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    Add Currency
                </a>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-800/50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Symbol</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Display Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pairs Count</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700/50">
                        {% for currency in currencies %}
                        <tr class="hover:bg-gray-700/50 transition-colors">
                            <td class="px-4 py-3 text-sm font-bold text-yellow-400">{{ currency.symbol }}</td>
                            <td class="px-4 py-3 text-sm text-white">{{ currency.name }}</td>
                            <td class="px-4 py-3 text-sm text-gray-300">{{ currency.display_name|default:"-" }}</td>
                            <td class="px-4 py-3 text-sm">
                                {% if currency.is_active %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        ✓ Active
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        ✗ Inactive
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-400">
                                {{ currency.base_pairs.count|add:currency.quote_pairs.count }} pairs
                            </td>
                            <td class="px-4 py-3 text-sm font-medium">
                                <a href="/admin/core/currency/{{ currency.id }}/change/" 
                                   class="text-blue-400 hover:text-blue-300 transition-colors">Edit</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                No currencies configured
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="content-settings" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- System Settings -->
            <div class="table-container">
                <div class="p-6 border-b border-gray-700/50">
                    <h2 class="text-xl font-semibold text-white">System Settings</h2>
                    <p class="text-gray-400 text-sm mt-1">Configure global system parameters</p>
                </div>
                
                <div class="p-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Default Arbitrage Threshold:</span>
                        <span class="text-white font-mono">0.5%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Default Min Volume:</span>
                        <span class="text-white font-mono">100</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Default Max Volume:</span>
                        <span class="text-white font-mono">10,000</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Worker Count:</span>
                        <span class="text-white font-mono">8</span>
                    </div>
                </div>
            </div>

            <!-- System Actions -->
            <div class="table-container">
                <div class="p-6 border-b border-gray-700/50">
                    <h2 class="text-xl font-semibold text-white">System Actions</h2>
                    <p class="text-gray-400 text-sm mt-1">Manage system operations</p>
                </div>
                
                <div class="p-6 space-y-4">
                    <button id="clear-redis" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Clear Redis Data
                    </button>
                    <button id="restart-workers" class="w-full px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                        Restart Workers
                    </button>
                    <button id="export-settings" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Export Settings
                    </button>
                    <button id="system-health" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        System Health Check
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Health Modal -->
<div id="health-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-white mb-4">System Health Status</h3>
        <div id="health-content" class="space-y-2">
            <!-- Health status will be populated here -->
        </div>
        <button id="close-health-modal" class="mt-4 w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
            Close
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tab functionality
document.getElementById('tab-exchanges').addEventListener('click', () => switchTab('exchanges'));
document.getElementById('tab-pairs').addEventListener('click', () => switchTab('pairs'));
document.getElementById('tab-currencies').addEventListener('click', () => switchTab('currencies'));
document.getElementById('tab-settings').addEventListener('click', () => switchTab('settings'));

function switchTab(tab) {
    // Update buttons
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    // Update content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    document.getElementById(`content-${tab}`).classList.remove('hidden');
}

// Add event listeners for all buttons
document.addEventListener('DOMContentLoaded', function() {
    // Exchange toggle buttons
    document.querySelectorAll('.exchange-toggle').forEach(button => {
        button.addEventListener('click', function() {
            const exchangeId = this.getAttribute('data-id');
            toggleExchange(exchangeId);
        });
    });
    
    // Pair toggle buttons
    document.querySelectorAll('.pair-toggle').forEach(button => {
        button.addEventListener('click', function() {
            const pairId = this.getAttribute('data-id');
            togglePair(pairId);
        });
    });
    
    // Test connection buttons
    document.querySelectorAll('.test-connection').forEach(button => {
        button.addEventListener('click', function() {
            const exchangeName = this.getAttribute('data-exchange');
            testConnection(exchangeName);
        });
    });
    
    // Test pair buttons
    document.querySelectorAll('.test-pair').forEach(button => {
        button.addEventListener('click', function() {
            const exchangeName = this.getAttribute('data-exchange');
            const symbol = this.getAttribute('data-symbol');
            testPair(exchangeName, symbol);
        });
    });
    
    // System action buttons
    document.getElementById('clear-redis').addEventListener('click', clearRedisData);
    document.getElementById('restart-workers').addEventListener('click', restartWorkers);
    document.getElementById('export-settings').addEventListener('click', exportSettings);
    document.getElementById('system-health').addEventListener('click', showSystemHealth);
    document.getElementById('close-health-modal').addEventListener('click', closeHealthModal);
});

// Toggle exchange status
async function toggleExchange(exchangeId) {
    try {
        const response = await fetch(`/toggle-exchange/${exchangeId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error toggling exchange: ' + error.message);
    }
}

// Toggle trading pair status
async function togglePair(pairId) {
    try {
        const response = await fetch(`/toggle-pair/${pairId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error toggling pair: ' + error.message);
    }
}

// Test connection
function testConnection(exchangeName) {
    alert(`Testing connection to ${exchangeName}...`);
    // Implement actual connection test
}

// Test trading pair
function testPair(exchangeName, symbol) {
    alert(`Testing ${exchangeName} pair ${symbol}...`);
    // Implement actual pair test
}

// System actions
function clearRedisData() {
    if (confirm('Are you sure you want to clear all Redis data?')) {
        alert('Redis data cleared successfully');
        // Implement actual Redis clear
    }
}

function restartWorkers() {
    if (confirm('Are you sure you want to restart all workers?')) {
        alert('Workers restarted successfully');
        // Implement actual worker restart
    }
}

function exportSettings() {
    alert('Exporting settings...');
    // Implement settings export
}

// System health check
async function showSystemHealth() {
    try {
        const response = await fetch('/api/system/health/');
        const data = await response.json();
        
        const healthContent = document.getElementById('health-content');
        healthContent.innerHTML = `
            <div class="flex justify-between">
                <span class="text-gray-400">Status:</span>
                <span class="text-green-400">${data.status}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Active Exchanges:</span>
                <span class="text-white">${data.exchanges.active}/${data.exchanges.total}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Active Pairs:</span>
                <span class="text-white">${data.pairs.active}/${data.pairs.total}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Currencies:</span>
                <span class="text-white">${data.currencies.active}/${data.currencies.total}</span>
            </div>
        `;
        
        document.getElementById('health-modal').classList.remove('hidden');
    } catch (error) {
        alert('Error checking system health: ' + error.message);
    }
}

function closeHealthModal() {
    document.getElementById('health-modal').classList.add('hidden');
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}