{% extends 'base.html' %}

{% block title %}Dashboard - Arbitrage Monitor{% endblock %}

{% block content %}
<!-- Toast Notifications Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-all duration-300">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                <span class="text-xl">üîÑ</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-400">Active Exchanges</p>
                <p class="text-2xl font-bold text-white">{{ active_exchanges }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-all duration-300">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                <span class="text-xl">üìä</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-400">Trading Pairs</p>
                <p class="text-2xl font-bold text-white">{{ active_pairs }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-all duration-300">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center">
                <span class="text-xl">üíé</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-400">Opportunities</p>
                <p class="text-2xl font-bold text-yellow-400" id="opportunities-count">0</p>
            </div>
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-all duration-300">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-lg flex items-center justify-center">
                <span class="text-xl">‚ö°</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-400">Redis Keys</p>
                <p class="text-2xl font-bold text-red-400" id="redis-keys-count">0</p>
            </div>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="mb-8">
    <div class="bg-gray-900/30 p-2 rounded-xl border border-gray-700">
        <nav class="flex space-x-2">
            <button id="tab-prices" class="clean-tab-button active">
                <i class="fas fa-chart-line mr-2"></i>
                Live Prices
                <div class="active-indicator"></div>
            </button>
            <button id="tab-opportunities" class="clean-tab-button">
                <i class="fas fa-exchange-alt mr-2"></i>
                Arbitrage Opportunities  
                <div class="active-indicator"></div>
            </button>
            <button id="tab-redis" class="clean-tab-button">
                <i class="fas fa-server mr-2"></i>
                System Monitor
                <div class="active-indicator"></div>
            </button>
        </nav>
    </div>
</div>

<!-- Live Prices Tab -->
<div id="content-prices" class="tab-content">
    <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
        
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-700/50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Exchange</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Currency Name</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Bid Price</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ask Price</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Bid Volume</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ask Volume</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Last Update</th>
                    </tr>
                </thead>
                <tbody id="prices-table" class="divide-y divide-gray-700/50">
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-3"></div>
                                <span>Loading live prices...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div id="no-prices" class="p-12 text-center text-gray-400 hidden">
            <div class="text-8xl mb-6 animate-pulse">üìä</div>
            <p class="text-xl font-semibold mb-2">No price data available</p>
            <p class="text-sm">Connecting to exchanges for live price feeds...</p>
        </div>
    </div>
</div>

<!-- Opportunities Tab -->
<div id="content-opportunities" class="tab-content hidden">
    <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
        <div class="px-6 py-4 border-b border-gray-700 bg-gradient-to-r from-green-900/20 to-green-800/20 rounded-t-xl">
            <h2 class="text-xl font-bold text-green-400 flex items-center">
                <span class="text-2xl mr-3">üöÄ</span>
                Real-time Arbitrage Opportunities
            </h2>
            <p class="text-sm text-gray-400 mt-1">Live detection of profitable trading opportunities</p>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-700/50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Currency</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Buy Exchange</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Sell Exchange</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Buy Price</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Sell Price</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Profit %</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Volume</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Time</th>
                    </tr>
                </thead>
                <tbody id="opportunities-table" class="divide-y divide-gray-700/50">
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mb-3"></div>
                                <span>Loading arbitrage opportunities...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div id="no-opportunities" class="p-12 text-center text-gray-400 hidden">
            <div class="text-8xl mb-6 animate-pulse">üîç</div>
            <p class="text-xl font-semibold mb-2">No arbitrage opportunities found</p>
            <p class="text-sm">Monitoring exchanges for profitable trades...</p>
        </div>
    </div>
</div>

<!-- Redis Monitor Tab -->
<div id="content-redis" class="tab-content hidden">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Redis Stats -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
            <div class="px-6 py-4 border-b border-gray-700 bg-gradient-to-r from-red-900/20 to-red-800/20 rounded-t-xl">
                <h3 class="text-lg font-bold text-red-400 flex items-center">
                    <span class="text-xl mr-2">‚ö°</span>
                    Redis Statistics
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Connected Clients</span>
                    <span class="text-white font-bold" id="redis-clients">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Total Commands</span>
                    <span class="text-white font-bold" id="redis-commands">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Memory Used</span>
                    <span class="text-yellow-400 font-bold" id="redis-memory">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Uptime</span>
                    <span class="text-green-400 font-bold" id="redis-uptime">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Cache Hit Rate</span>
                    <span class="text-blue-400 font-bold" id="redis-hit-rate">-</span>
                </div>
            </div>
        </div>
        
        <!-- Key Statistics -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
            <div class="px-6 py-4 border-b border-gray-700 bg-gradient-to-r from-purple-900/20 to-purple-800/20 rounded-t-xl">
                <h3 class="text-lg font-bold text-purple-400 flex items-center">
                    <span class="text-xl mr-2">üîë</span>
                    Key Statistics
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Price Keys</span>
                    <span class="text-green-400 font-bold" id="redis-price-keys">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Opportunity Keys</span>
                    <span class="text-yellow-400 font-bold" id="redis-opportunity-keys">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Redis Version</span>
                    <span class="text-blue-400 font-bold" id="redis-version">-</span>
                </div>
                
                <!-- Live Activity Chart -->
                <div class="mt-6">
                    <h4 class="text-sm font-semibold text-gray-400 mb-3">Live Activity</h4>
                    <div class="bg-gray-700/30 rounded-lg p-4">
                        <canvas id="redis-activity-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.tab-button {
    @apply flex-1 px-6 py-3 text-sm font-medium rounded-lg transition-all duration-300;
    @apply text-gray-400 hover:text-white hover:bg-gray-700/50;
}

.tab-button.active {
    @apply text-white bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg;
}

/* Clean Tab Buttons */
.clean-tab-button {
    @apply relative py-3 px-6 text-sm font-medium transition-all duration-300;
    @apply text-gray-500 hover:text-gray-300;
    @apply bg-gray-800/50 border border-gray-700 rounded-lg mr-2;
    @apply focus:outline-none focus:ring-2 focus:ring-blue-500/50;
    @apply whitespace-nowrap;
}

.clean-tab-button.active {
    @apply text-white bg-blue-600 border-blue-500;
    @apply font-semibold shadow-lg shadow-blue-500/25;
    @apply transform scale-105;
}

.clean-tab-button .active-indicator {
    @apply absolute -bottom-0.5 left-1/2 transform -translate-x-1/2;
    @apply w-2 h-2 bg-blue-400 rounded-full;
    @apply opacity-0 transition-all duration-300;
}

.clean-tab-button.active .active-indicator {
    @apply opacity-100 bg-white;
}

.clean-tab-button:hover:not(.active) {
    @apply bg-gray-700/70 border-gray-600 text-gray-200;
    @apply transform scale-102;
}

.clean-tab-button:hover:not(.active) .active-indicator {
    @apply opacity-60 bg-gray-400;
}

.profit-positive {
    @apply text-green-400 font-bold text-lg;
}

.exchange-badge {
    @apply px-3 py-1 text-xs font-bold rounded-full uppercase tracking-wide;
}

.exchange-wallex {
    @apply bg-blue-500/20 text-blue-400 border border-blue-500/30;
}

.exchange-lbank {
    @apply bg-green-500/20 text-green-400 border border-green-500/30;
}

.exchange-ramzinex {
    @apply bg-purple-500/20 text-purple-400 border border-purple-500/30;
}

.price-update {
    animation: simple-flash 1.2s ease-out;
    transform: translateZ(0); /* Force GPU acceleration */
}

@keyframes simple-flash {
    0% { 
        border-left: 4px solid #10b981;
        background-color: rgba(16, 185, 129, 0.1);
        color: #10b981;
        font-weight: 500;
    }
    100% { 
        border-left: 4px solid transparent;
        background-color: transparent;
        color: inherit; 
        font-weight: inherit;
    }
}

.opportunity-row {
    @apply hover:bg-gray-700/30 transition-all duration-300 cursor-pointer;
}

.opportunity-row:hover {
    @apply transform scale-[1.01] shadow-lg;
}
</style>

<script>
let opportunities = [];
let prices = {};
let redisStats = {};
let activityChart = null;
let activityData = [];
let opportunityCount = 0; // Track opportunity count for notifications

// Initialize Chart
function initChart() {
    const ctx = document.getElementById('redis-activity-chart').getContext('2d');
    
    // Simple chart implementation
    activityChart = {
        ctx: ctx,
        data: [],
        draw: function() {
            const canvas = ctx.canvas;
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 10; i++) {
                const x = (width / 10) * i;
                const y = (height / 10) * i;
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw data
            if (this.data.length > 1) {
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                for (let i = 0; i < this.data.length; i++) {
                    const x = (width / (this.data.length - 1)) * i;
                    const y = height - (this.data[i] / Math.max(...this.data)) * height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.stroke();
            }
        }
    };
}

// Toast Notifications
function showToast(message, type = 'success', duration = 5000) {
    const toast = document.createElement('div');
    toast.className = `
        bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-lg max-w-sm w-full
        transform transition-all duration-300 ease-in-out translate-x-full opacity-0
        ${type === 'success' ? 'border-green-500 bg-green-900/20' : ''}
        ${type === 'info' ? 'border-blue-500 bg-blue-900/20' : ''}
        ${type === 'warning' ? 'border-yellow-500 bg-yellow-900/20' : ''}
        ${type === 'error' ? 'border-red-500 bg-red-900/20' : ''}
    `;
    
    const iconMap = {
        success: 'üöÄ',
        info: 'üíé',
        warning: '‚ö†Ô∏è',
        error: '‚ùå'
    };
    
    const colorMap = {
        success: 'text-green-400',
        info: 'text-blue-400',
        warning: 'text-yellow-400',
        error: 'text-red-400'
    };
    
    toast.innerHTML = `
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <span class="text-xl">${iconMap[type]}</span>
            </div>
            <div class="ml-3 w-0 flex-1">
                <p class="text-sm font-medium text-white">
                    ${message}
                </p>
            </div>
            <div class="ml-4 flex-shrink-0 flex">
                <button class="bg-gray-700 rounded-md inline-flex text-gray-400 hover:text-gray-200 focus:outline-none" onclick="this.parentElement.parentElement.parentElement.remove()">
                    <span class="sr-only">Close</span>
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('toast-container').appendChild(toast);
    
    // Animate in
    requestAnimationFrame(() => {
        toast.classList.remove('translate-x-full', 'opacity-0');
        toast.classList.add('translate-x-0', 'opacity-100');
    });
    
    // Auto remove after duration
    setTimeout(() => {
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, duration);
}

function showOpportunityToast(opportunity) {
    const profit = opportunity.profit_percentage.toFixed(2);
    const symbol = `${opportunity.base_currency}/${opportunity.quote_currency}`;
    const message = `New Opportunity Found! ${symbol} - ${profit}% profit`;
    showToast(message, 'success', 5000);
}

// Tab functionality
document.getElementById('tab-prices').addEventListener('click', () => switchTab('prices'));
document.getElementById('tab-opportunities').addEventListener('click', () => switchTab('opportunities'));
document.getElementById('tab-redis').addEventListener('click', () => switchTab('redis'));

function switchTab(tab) {
    // Update buttons
    document.querySelectorAll('.clean-tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    // Update content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    document.getElementById(`content-${tab}`).classList.remove('hidden');
    
    // Initialize chart if redis tab
    if (tab === 'redis' && !activityChart) {
        setTimeout(() => {
            initChart();
        }, 100);
    }
}


function updateOpportunitiesTable() {
    const tbody = document.getElementById('opportunities-table');
    const noOpportunities = document.getElementById('no-opportunities');
    const countElement = document.getElementById('opportunities-count');
    
    // Check for new opportunities and show toast
    if (opportunities.length > opportunityCount) {
        const newOpportunities = opportunities.length - opportunityCount;
        if (opportunityCount > 0) { // Don't show toast on initial load
            const latestOpportunity = opportunities[0]; // Assume sorted by latest
            showOpportunityToast(latestOpportunity);
            
            // Also show count change toast
            showToast(`${newOpportunities} new arbitrage opportunity${newOpportunities > 1 ? 'ies' : ''} detected!`, 'info', 3000);
        }
    }
    
    opportunityCount = opportunities.length;
    countElement.textContent = opportunities.length;
    
    if (opportunities.length === 0) {
        tbody.innerHTML = '';
        noOpportunities.classList.remove('hidden');
        return;
    }
    
    noOpportunities.classList.add('hidden');
    
    // Save scroll position before any changes
    const scrollElement = document.querySelector('.overflow-x-auto') || window;
    const scrollTop = scrollElement.scrollTop || window.scrollY;
    const scrollLeft = scrollElement.scrollLeft || window.scrollX;
    
    // Sort by profit percentage
    opportunities.sort((a, b) => b.profit_percentage - a.profit_percentage);
    
    const newContent = opportunities.slice(0, 100).map(opp => `
        <tr class="opportunity-row">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="text-sm font-bold text-white">
                        ${opp.base_currency}/${opp.quote_currency}
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="exchange-badge exchange-${opp.buy_exchange}">
                    ${opp.buy_exchange}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="exchange-badge exchange-${opp.sell_exchange}">
                    ${opp.sell_exchange}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 font-mono">
                $${opp.buy_price.toFixed(6)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 font-mono">
                $${opp.sell_price.toFixed(6)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="profit-positive">
                    +${opp.profit_percentage.toFixed(2)}%
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 font-mono">
                ${opp.volume.toFixed(4)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                ${formatTimestampTehran(opp.timestamp)}
            </td>
        </tr>
    `).join('');
    
    // Only update if content actually changed to prevent scroll jumping
    if (tbody.innerHTML.trim() !== newContent.trim()) {
        tbody.innerHTML = newContent;
        
        // Restore scroll position after update
        requestAnimationFrame(() => {
            if (scrollElement.scrollTo) {
                scrollElement.scrollTo(scrollLeft, scrollTop);
            } else {
                scrollElement.scrollTop = scrollTop;
                scrollElement.scrollLeft = scrollLeft;
                window.scrollTo(scrollLeft, scrollTop);
            }
        });
    }
}

function updatePricesTable() {
    const tbody = document.getElementById('prices-table');
    const priceArray = Object.values(prices);
    
    if (priceArray.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-3"></div>
                        <span>Loading live prices...</span>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    // Sort by exchange and symbol
    priceArray.sort((a, b) => {
        if (a.exchange !== b.exchange) {
            return a.exchange.localeCompare(b.exchange);
        }
        return a.symbol.localeCompare(b.symbol);
    });
    
    // Get all scroll containers and save their positions
    const tableContainer = document.querySelector('.overflow-x-auto');
    const scrollState = {
        container: {
            element: tableContainer,
            scrollTop: tableContainer ? tableContainer.scrollTop : 0,
            scrollLeft: tableContainer ? tableContainer.scrollLeft : 0
        },
        window: {
            scrollX: window.scrollX,
            scrollY: window.scrollY
        }
    };
    
    // Check if table structure needs rebuilding
    const existingRows = tbody.querySelectorAll('tr[data-price-key]');
    const currentKeys = priceArray.map(p => `${p.exchange}_${p.symbol}`);
    const existingKeys = Array.from(existingRows).map(row => row.getAttribute('data-price-key'));
    
    // If structure changed, rebuild entire table
    if (JSON.stringify(currentKeys.sort()) !== JSON.stringify(existingKeys.sort())) {
        tbody.innerHTML = priceArray.map(price => createPriceRow(price)).join('');
        
        // Restore ALL scroll positions after rebuild
        setTimeout(() => {
            if (scrollState.container.element) {
                scrollState.container.element.scrollTop = scrollState.container.scrollTop;
                scrollState.container.element.scrollLeft = scrollState.container.scrollLeft;
            }
            window.scrollTo(scrollState.window.scrollX, scrollState.window.scrollY);
        }, 0);
    } else {
        // Update existing rows individually - completely prevent any reflow
        priceArray.forEach(price => {
            updatePriceRow(price);
        });
    }
}

function createPriceRow(price) {
    const key = `${price.exchange}_${price.symbol}`;
    return `
        <tr class="hover:bg-gray-700/30 transition-all duration-300" data-price-key="${key}">
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="exchange-badge exchange-${price.exchange}">
                    ${price.exchange}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                <span class="font-medium">${getCurrencyName(price.symbol)}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-400 font-mono" data-field="bid_price">
                $${parseFloat(price.bid_price).toFixed(6)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-400 font-mono" data-field="ask_price">
                $${parseFloat(price.ask_price).toFixed(6)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 font-mono" data-field="bid_volume">
                ${parseFloat(price.bid_volume || 0).toFixed(4)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 font-mono" data-field="ask_volume">
                ${parseFloat(price.ask_volume || 0).toFixed(4)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400" data-field="timestamp">
                ${formatTimestampTehran(price.timestamp)}
            </td>
        </tr>
    `;
}

function updatePriceRow(price) {
    const key = `${price.exchange}_${price.symbol}`;
    const row = document.querySelector(`tr[data-price-key="${key}"]`);
    
    if (!row) return;
    
    // Update individual cells with animation
    const bidPriceCell = row.querySelector('[data-field="bid_price"]');
    const askPriceCell = row.querySelector('[data-field="ask_price"]');
    const bidVolumeCell = row.querySelector('[data-field="bid_volume"]');
    const askVolumeCell = row.querySelector('[data-field="ask_volume"]');
    const timestampCell = row.querySelector('[data-field="timestamp"]');
    
    // Check if values changed and animate only changed cells
    const newBidPrice = `$${parseFloat(price.bid_price).toFixed(6)}`;
    const newAskPrice = `$${parseFloat(price.ask_price).toFixed(6)}`;
    const newBidVolume = `${parseFloat(price.bid_volume || 0).toFixed(4)}`;
    const newAskVolume = `${parseFloat(price.ask_volume || 0).toFixed(4)}`;
    const newTimestamp = formatTimestampTehran(price.timestamp);
    
    if (bidPriceCell.textContent !== newBidPrice) {
        bidPriceCell.textContent = newBidPrice;
        animateCell(bidPriceCell);
    }
    
    if (askPriceCell.textContent !== newAskPrice) {
        askPriceCell.textContent = newAskPrice;
        animateCell(askPriceCell);
    }
    
    if (bidVolumeCell.textContent !== newBidVolume) {
        bidVolumeCell.textContent = newBidVolume;
        animateCell(bidVolumeCell);
    }
    
    if (askVolumeCell.textContent !== newAskVolume) {
        askVolumeCell.textContent = newAskVolume;
        animateCell(askVolumeCell);
    }
    
    // Always update timestamp (no animation needed)
    timestampCell.textContent = newTimestamp;
}

function animateCell(cell) {
    // Remove existing animation class
    cell.classList.remove('price-update');
    
    // Force reflow
    void cell.offsetHeight;
    
    // Add animation class
    cell.classList.add('price-update');
    
    // Remove animation class after animation completes
    setTimeout(() => {
        cell.classList.remove('price-update');
    }, 1200);
}

function updateRedisStats() {
    document.getElementById('redis-clients').textContent = redisStats.connected_clients || '-';
    document.getElementById('redis-commands').textContent = (redisStats.total_commands || 0).toLocaleString();
    document.getElementById('redis-memory').textContent = redisStats.memory_used || '-';
    document.getElementById('redis-uptime').textContent = formatUptime(redisStats.uptime_seconds || 0);
    document.getElementById('redis-price-keys').textContent = redisStats.price_keys_count || '-';
    document.getElementById('redis-opportunity-keys').textContent = redisStats.opportunity_keys_count || '-';
    document.getElementById('redis-version').textContent = redisStats.version || '-';
    document.getElementById('redis-keys-count').textContent = (redisStats.price_keys_count || 0) + (redisStats.opportunity_keys_count || 0);
    
    // Calculate hit rate
    const hits = redisStats.keyspace_hits || 0;
    const misses = redisStats.keyspace_misses || 0;
    const total = hits + misses;
    const hitRate = total > 0 ? ((hits / total) * 100).toFixed(1) + '%' : '-';
    document.getElementById('redis-hit-rate').textContent = hitRate;
    
    // Update activity chart
    if (activityChart && redisStats.total_commands) {
        activityData.push(redisStats.total_commands);
        if (activityData.length > 50) {
            activityData.shift();
        }
        activityChart.data = activityData;
        activityChart.draw();
    }
}

function formatTimestamp(timestamp) {
    return new Date(timestamp * 1000).toLocaleTimeString();
}

function formatTimestampTehran(timestamp) {
    const now = Date.now() / 1000; // Current time in seconds
    const diffSeconds = now - timestamp;
    
    // Only show seconds with proper formatting
    if (diffSeconds < 0) {
        return 'just now';
    } else if (diffSeconds < 1) {
        return 'just now';
    } else if (diffSeconds < 60) {
        const seconds = Math.floor(diffSeconds);
        return seconds === 1 ? '1 second ago' : `${seconds} seconds ago`;
    } else if (diffSeconds < 3600) {
        const minutes = Math.floor(diffSeconds / 60);
        return minutes === 1 ? '1 minute ago' : `${minutes} minutes ago`;
    } else {
        const hours = Math.floor(diffSeconds / 3600);
        return hours === 1 ? '1 hour ago' : `${hours} hours ago`;
    }
}

function getCurrencyName(symbol) {
    // Use dynamic currency mapping from database
    const currencyMapping = JSON.parse('{{ currency_mapping_json|escapejs }}');
    return currencyMapping[symbol] ? currencyMapping[symbol].name : symbol;
}


function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    if (days > 0) {
        return `${days}d ${hours}h ${minutes}m`;
    } else if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else {
        return `${minutes}m`;
    }
}

// Auto-refresh timestamp display
setInterval(() => {
    updateOpportunitiesTable();
}, 1000);

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (document.getElementById('content-redis').classList.contains('hidden') === false) {
            initChart();
        }
    }, 500);
});
</script>
{% endblock %}

{% block scripts %}
<script>
// Override the base WebSocket message handler
function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'initial_opportunities':
            opportunities = data.data;
            opportunityCount = opportunities.length; // Set initial count without toast
            updateOpportunitiesTable();
            break;
            
        case 'opportunities_update':
            opportunities = data.data;
            updateOpportunitiesTable();
            break;
            
        case 'initial_prices':
            data.data.forEach(price => {
                const key = `${price.exchange}_${price.symbol}`;
                prices[key] = price;
            });
            updatePricesTable();
            break;
            
        case 'prices_update':
            data.data.forEach(price => {
                const key = `${price.exchange}_${price.symbol}`;
                prices[key] = price;
            });
            updatePricesTable();
            break;
            
        case 'price_update':
            const key = `${data.data.exchange}_${data.data.symbol}`;
            prices[key] = data.data;
            updatePricesTable();
            break;
            
        case 'redis_stats':
            redisStats = data.data;
            updateRedisStats();
            break;
    }
}
</script>
{% endblock %}