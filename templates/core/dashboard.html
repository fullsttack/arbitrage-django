{% extends 'base.html' %}

{% block title %}Dashboard - Arbitrage Monitor{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-all duration-300">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                <span class="text-xl">üîÑ</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-400">Active Exchanges</p>
                <p class="text-2xl font-bold text-white">{{ active_exchanges }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-all duration-300">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                <span class="text-xl">üìä</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-400">Trading Pairs</p>
                <p class="text-2xl font-bold text-white">{{ active_pairs }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-all duration-300">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center">
                <span class="text-xl">üíé</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-400">Opportunities</p>
                <p class="text-2xl font-bold text-yellow-400" id="opportunities-count">0</p>
            </div>
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-all duration-300">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-lg flex items-center justify-center">
                <span class="text-xl">‚ö°</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-400">Redis Keys</p>
                <p class="text-2xl font-bold text-red-400" id="redis-keys-count">0</p>
            </div>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="flex space-x-1 mb-6 bg-gray-800 p-1 rounded-xl border border-gray-700">
    <button id="tab-opportunities" class="tab-button active">
        <span class="text-lg mr-2">üéØ</span>
        Arbitrage Opportunities
    </button>
    <button id="tab-prices" class="tab-button">
        <span class="text-lg mr-2">üí∞</span>
        Live Prices
    </button>
    <button id="tab-redis" class="tab-button">
        <span class="text-lg mr-2">üìä</span>
        Redis Monitor
    </button>
</div>

<!-- Opportunities Tab -->
<div id="content-opportunities" class="tab-content">
    <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
        <div class="px-6 py-4 border-b border-gray-700 bg-gradient-to-r from-green-900/20 to-green-800/20 rounded-t-xl">
            <h2 class="text-xl font-bold text-green-400 flex items-center">
                <span class="text-2xl mr-3">üöÄ</span>
                Real-time Arbitrage Opportunities
            </h2>
            <p class="text-sm text-gray-400 mt-1">Live detection of profitable trading opportunities</p>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-700/50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Currency</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Buy Exchange</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Sell Exchange</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Buy Price</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Sell Price</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Profit %</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Volume</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Time</th>
                    </tr>
                </thead>
                <tbody id="opportunities-table" class="divide-y divide-gray-700/50">
                    <!-- Opportunities will be populated here -->
                </tbody>
            </table>
        </div>
        
        <div id="no-opportunities" class="p-12 text-center text-gray-400 hidden">
            <div class="text-8xl mb-6 animate-pulse">üîç</div>
            <p class="text-xl font-semibold mb-2">No arbitrage opportunities found</p>
            <p class="text-sm">Monitoring exchanges for profitable trades...</p>
        </div>
    </div>
</div>

<!-- Prices Tab -->
<div id="content-prices" class="tab-content hidden">
    <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
        <div class="px-6 py-4 border-b border-gray-700 bg-gradient-to-r from-blue-900/20 to-blue-800/20 rounded-t-xl">
            <h2 class="text-xl font-bold text-blue-400 flex items-center">
                <span class="text-2xl mr-3">üìà</span>
                Live Exchange Prices
            </h2>
            <p class="text-sm text-gray-400 mt-1">Real-time price data from all connected exchanges</p>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-700/50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Exchange</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Symbol</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Bid Price</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ask Price</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Volume</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Last Update</th>
                    </tr>
                </thead>
                <tbody id="prices-table" class="divide-y divide-gray-700/50">
                    <!-- Prices will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Redis Monitor Tab -->
<div id="content-redis" class="tab-content hidden">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Redis Stats -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
            <div class="px-6 py-4 border-b border-gray-700 bg-gradient-to-r from-red-900/20 to-red-800/20 rounded-t-xl">
                <h3 class="text-lg font-bold text-red-400 flex items-center">
                    <span class="text-xl mr-2">‚ö°</span>
                    Redis Statistics
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Connected Clients</span>
                    <span class="text-white font-bold" id="redis-clients">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Total Commands</span>
                    <span class="text-white font-bold" id="redis-commands">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Memory Used</span>
                    <span class="text-yellow-400 font-bold" id="redis-memory">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Uptime</span>
                    <span class="text-green-400 font-bold" id="redis-uptime">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Cache Hit Rate</span>
                    <span class="text-blue-400 font-bold" id="redis-hit-rate">-</span>
                </div>
            </div>
        </div>
        
        <!-- Key Statistics -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-2xl">
            <div class="px-6 py-4 border-b border-gray-700 bg-gradient-to-r from-purple-900/20 to-purple-800/20 rounded-t-xl">
                <h3 class="text-lg font-bold text-purple-400 flex items-center">
                    <span class="text-xl mr-2">üîë</span>
                    Key Statistics
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Price Keys</span>
                    <span class="text-green-400 font-bold" id="redis-price-keys">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Opportunity Keys</span>
                    <span class="text-yellow-400 font-bold" id="redis-opportunity-keys">-</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg">
                    <span class="text-gray-400">Redis Version</span>
                    <span class="text-blue-400 font-bold" id="redis-version">-</span>
                </div>
                
                <!-- Live Activity Chart -->
                <div class="mt-6">
                    <h4 class="text-sm font-semibold text-gray-400 mb-3">Live Activity</h4>
                    <div class="bg-gray-700/30 rounded-lg p-4">
                        <canvas id="redis-activity-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.tab-button {
    @apply flex-1 px-6 py-3 text-sm font-medium rounded-lg transition-all duration-300;
    @apply text-gray-400 hover:text-white hover:bg-gray-700/50;
}

.tab-button.active {
    @apply text-white bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg;
}

.profit-positive {
    @apply text-green-400 font-bold text-lg;
}

.exchange-badge {
    @apply px-3 py-1 text-xs font-bold rounded-full uppercase tracking-wide;
}

.exchange-wallex {
    @apply bg-blue-500/20 text-blue-400 border border-blue-500/30;
}

.exchange-lbank {
    @apply bg-green-500/20 text-green-400 border border-green-500/30;
}

.exchange-ramzinex {
    @apply bg-purple-500/20 text-purple-400 border border-purple-500/30;
}

.price-update {
    animation: flash 0.8s ease-in-out;
}

@keyframes flash {
    0% { background-color: rgba(34, 197, 94, 0.2); transform: scale(1); }
    50% { background-color: rgba(34, 197, 94, 0.4); transform: scale(1.02); }
    100% { background-color: transparent; transform: scale(1); }
}

.opportunity-row {
    @apply hover:bg-gray-700/30 transition-all duration-300 cursor-pointer;
}

.opportunity-row:hover {
    @apply transform scale-[1.01] shadow-lg;
}
</style>

<script>
let opportunities = [];
let prices = {};
let redisStats = {};
let activityChart = null;
let activityData = [];

// Initialize Chart
function initChart() {
    const ctx = document.getElementById('redis-activity-chart').getContext('2d');
    
    // Simple chart implementation
    activityChart = {
        ctx: ctx,
        data: [],
        draw: function() {
            const canvas = ctx.canvas;
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 10; i++) {
                const x = (width / 10) * i;
                const y = (height / 10) * i;
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw data
            if (this.data.length > 1) {
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                for (let i = 0; i < this.data.length; i++) {
                    const x = (width / (this.data.length - 1)) * i;
                    const y = height - (this.data[i] / Math.max(...this.data)) * height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.stroke();
            }
        }
    };
}

// Tab functionality
document.getElementById('tab-opportunities').addEventListener('click', () => switchTab('opportunities'));
document.getElementById('tab-prices').addEventListener('click', () => switchTab('prices'));
document.getElementById('tab-redis').addEventListener('click', () => switchTab('redis'));

function switchTab(tab) {
    // Update buttons
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    // Update content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    document.getElementById(`content-${tab}`).classList.remove('hidden');
    
    // Initialize chart if redis tab
    if (tab === 'redis' && !activityChart) {
        setTimeout(() => {
            initChart();
        }, 100);
    }
}

// WebSocket message handler
function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'initial_opportunities':
            opportunities = data.data;
            updateOpportunitiesTable();
            break;
            
        case 'opportunities_update':
            opportunities = data.data;
            updateOpportunitiesTable();
            break;
            
        case 'initial_prices':
            data.data.forEach(price => {
                const key = `${price.exchange}_${price.symbol}`;
                prices[key] = price;
            });
            updatePricesTable();
            break;
            
        case 'price_update':
            const key = `${data.data.exchange}_${data.data.symbol}`;
            prices[key] = data.data;
            updatePricesTable();
            break;
            
        case 'redis_stats':
            redisStats = data.data;
            updateRedisStats();
            break;
    }
}

function updateOpportunitiesTable() {
    const tbody = document.getElementById('opportunities-table');
    const noOpportunities = document.getElementById('no-opportunities');
    const countElement = document.getElementById('opportunities-count');
    
    countElement.textContent = opportunities.length;
    
    if (opportunities.length === 0) {
        tbody.innerHTML = '';
        noOpportunities.classList.remove('hidden');
        return;
    }
    
    noOpportunities.classList.add('hidden');
    
    // Sort by profit percentage
    opportunities.sort((a, b) => b.profit_percentage - a.profit_percentage);
    
    tbody.innerHTML = opportunities.slice(0, 100).map(opp => `
        <tr class="opportunity-row">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="text-sm font-bold text-white">
                        ${opp.base_currency}/${opp.quote_currency}
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="exchange-badge exchange-${opp.buy_exchange}">
                    ${opp.buy_exchange}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="exchange-badge exchange-${opp.sell_exchange}">
                    ${opp.sell_exchange}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 font-mono">
                $${opp.buy_price.toFixed(6)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 font-mono">
                $${opp.sell_price.toFixed(6)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="profit-positive">
                    +${opp.profit_percentage.toFixed(2)}%
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 font-mono">
                ${opp.volume.toFixed(4)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                ${formatTimestamp(opp.timestamp)}
            </td>
        </tr>
    `).join('');
}

function updatePricesTable() {
    const tbody = document.getElementById('prices-table');
    const priceArray = Object.values(prices);
    
    // Sort by exchange and symbol
    priceArray.sort((a, b) => {
        if (a.exchange !== b.exchange) {
            return a.exchange.localeCompare(b.exchange);
        }
        return a.symbol.localeCompare(b.symbol);
    });
    
    tbody.innerHTML = priceArray.map(price => `
        <tr class="hover:bg-gray-700/30 transition-all duration-300 price-update">
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="exchange-badge exchange-${price.exchange}">
                    ${price.exchange}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-white">
                ${price.symbol}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-400 font-mono">
                $${parseFloat(price.bid_price).toFixed(6)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-400 font-mono">
                $${parseFloat(price.ask_price).toFixed(6)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 font-mono">
                ${parseFloat(price.volume).toFixed(4)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                ${formatTimestamp(price.timestamp)}
            </td>
        </tr>
    `).join('');
}

function updateRedisStats() {
    document.getElementById('redis-clients').textContent = redisStats.connected_clients || '-';
    document.getElementById('redis-commands').textContent = (redisStats.total_commands || 0).toLocaleString();
    document.getElementById('redis-memory').textContent = redisStats.memory_used || '-';
    document.getElementById('redis-uptime').textContent = formatUptime(redisStats.uptime_seconds || 0);
    document.getElementById('redis-price-keys').textContent = redisStats.price_keys_count || '-';
    document.getElementById('redis-opportunity-keys').textContent = redisStats.opportunity_keys_count || '-';
    document.getElementById('redis-version').textContent = redisStats.version || '-';
    document.getElementById('redis-keys-count').textContent = (redisStats.price_keys_count || 0) + (redisStats.opportunity_keys_count || 0);
    
    // Calculate hit rate
    const hits = redisStats.keyspace_hits || 0;
    const misses = redisStats.keyspace_misses || 0;
    const total = hits + misses;
    const hitRate = total > 0 ? ((hits / total) * 100).toFixed(1) + '%' : '-';
    document.getElementById('redis-hit-rate').textContent = hitRate;
    
    // Update activity chart
    if (activityChart && redisStats.total_commands) {
        activityData.push(redisStats.total_commands);
        if (activityData.length > 50) {
            activityData.shift();
        }
        activityChart.data = activityData;
        activityChart.draw();
    }
}

function formatTimestamp(timestamp) {
    return new Date(timestamp * 1000).toLocaleTimeString();
}

function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    if (days > 0) {
        return `${days}d ${hours}h ${minutes}m`;
    } else if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else {
        return `${minutes}m`;
    }
}

// Auto-refresh timestamp display
setInterval(() => {
    updateOpportunitiesTable();
}, 1000);

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (document.getElementById('content-redis').classList.contains('hidden') === false) {
            initChart();
        }
    }, 500);
});
</script>
{% endblock %}